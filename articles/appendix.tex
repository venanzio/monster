
\section{Appendix}

\hide{
\begin{lemmaa}{\ref{lemma:monster_pure}}
$$
\apure_{\stream{M}}\,a = \mcons\,(\apure_M\,\langle a, \apure_{\stream{M}}\,a\rangle)
$$
\end{lemmaa}
\begin{proof}
By unfolding definitions and using the identity law for the applicative functor $M$:
$$
\begin{array}{ll}
\apure_{\stream{M}}\,a \\
{}= a \acons \apure_{\stream{M}}\,a
  & \mbox{definition of }\apure_{\stream{M}} \\
{}= (\apure_M\,a) \fcons (\apure_{\stream{M}}\,a)
  & \mbox{definition of }\acons\\
{}=  \mcons\, (M\,(\lambda a. \langle a, \apure_{\stream{M}}\,a\rangle)\,(\apure_M\,a))
  & \mbox{definition of }\fcons\\
{}= \mcons\, (\apure_M\,(\lambda a. \langle a, \apure_{\stream{M}}\,a\rangle) \appl \apure_M\,a)
  & \mbox{functoriality of applicatives}\\
{}= \mcons\, (\apure_M\,((\lambda a. \langle a, \apure_{\stream{M}}\,a\rangle)\,a))
  & \mbox{the homomorphism law for }M\\
{}= \mcons\, (\apure_M\,\langle a, \apure_{\stream{M}}\,a\rangle)
  & \mbox{function application}
\end{array}
$$
\end{proof}
}
%---

\hide{
\begin{lemmaa}{\ref{lemma:pure_lift}}
For an applicative functor $M$, with $a:A$, $b:B$ and $(\oplus) : A \rightarrow B \rightarrow C$:
$$
(\apure_M\, a) \alift{\oplus} (\apure_M\, b) = \apure_M\, (a \oplus b)
$$
\end{lemmaa}
\begin{proof}
$$
\begin{array}{ll}
(\apure_M\, a) \alift{\oplus} (\apure_M\, b) \\
{}= \apure_M\, (\oplus) \appl \apure_M\, a \appl \apure_M\, b
  & \mbox{definition of }\alift{-}\\
{}= \apure_M\, (a\, \oplus) \appl \apure_M\, b
  & \mbox{homomorphism law of }M\\
{}= \apure_M\, (a \oplus b)
  & \mbox{homomorphism law of }M\\
\end{array}
$$
\end{proof}

%---

\begin{lemmaa}{\ref{lemma:pappl_comp_appl}}
Assuming $M$ is an applicative, with $f : A \rightarrow B \rightarrow C$, $m_a : M\, A$ and $b : B$:
$$
\apure_M\, f \appl m_a \appl \apure_M\, b = \apure_M\, (\lambda a . f\, a\, b) \appl m_a
$$
\end{lemmaa}
\begin{proof}
Since the operator $\appl$ is left-associative, the left hand side of the equality is read as:
$$
(\apure_M\, f \appl m_a) \appl \apure_M\, b
$$
which means that we can apply the interchange law to it.
In the application of the law we abstract a variable $h$ of type $B\rightarrow C$:
$$
\begin{array}{ll}
\apure_M\, f \appl m_a \appl \apure_M\, b \\
{} =  \apure_M\, (\lambda h. h\, b) \appl (\apure_M\, f \appl m_a)
 & \mbox{interchange law of }M\\
{} =  (\apure_M\, (\lambda h. h\, b) \alift{\comp} \apure_M\, f) \appl m_a
 & \mbox{composition law of }M\\
{} =  \apure_M ( (\lambda h. h\, b) \comp f ) ) \appl m_a
 & \mbox{Lemma \ref{lemma:pure_lift}}\\
{} =  \apure_M (\lambda a. f\, a\, b ) \appl m_a
 & \mbox{definition of composition}\\
\end{array}
$$
\end{proof}
}
%---

\begin{lemmaa}{\ref{lemma:pappl_comp_appl}}
Let $m_g:\mstream{B\rightarrow C}$, $m_f:\mstream{A\rightarrow B}$, $m_a:\mstream{A}$, then:
$$
m_g \alift{\pappl} (m_f \alift{\pappl} m_a)
 = \apure\, (\lambda \pstr{g}. \lambda \pstr{f}. \lambda \pstr{a}. \pstr{g} \pappl (\pstr{f}\pappl \pstr{a})) \appl m_g \appl m_f \appl m_a
$$
\end{lemmaa}
\begin{proof}
$$
\begin{array}{ll}
m_g \alift{\pappl} (m_f \alift{\pappl} m_a) \\
{}= \apure\, (\pappl) \appl m_g \appl (\apure\, (\pappl) \appl m_f \appl m_a) \\
 \mbox{definition of }\alift{-}\\
{}= (\apure\, (\pappl) \appl m_g) \alift{\comp} (\apure\, (\pappl) \appl m_f)  \appl m_a \\
 \mbox{composition law for }M \\
{}=   \apure\, (\comp) \appl  (\apure\, (\pappl) \appl m_g) \appl (\apure\, (\pappl) \appl m_f) \appl m_a \\
 \mbox{definition of }\alift{-}\\
{}=   (\apure\, (\comp) \alift{\comp}  \apure\, (\pappl)) \appl m_g \appl (\apure\, (\pappl) \appl m_f) \appl m_a \\
 \mbox{composition law for }M \\
{}=   ( \apure\, ((\comp) \comp (\pappl)) \appl m_g ) \appl (\apure\, (\pappl) \appl m_f)   \appl m_a\\
 \mbox{Lemma \ref{lemma:pure_lift}}\\
{}=   ( \apure\, (\clift{\pappl}{\pstream{A}}) \appl m_g ) \appl (\apure\, (\pappl) \appl m_f)   \appl m_a\\
 \mbox{definition}\\
{}=   ( ( \apure\, (\clift{\pappl}{\pstream{A}})  \appl m_g ) \alift{\comp} \apure\, (\pappl)) \appl m_f  \appl m_a\\
 \mbox{composition law for }M \\
{}=  \apure\, (\comp) \appl (\apure\, (\clift{\pappl}{\pstream{A}})  \appl m_g ) \appl \apure\, (\pappl)  \appl m_f  \appl m_a\\
 \mbox{definition of }\alift{-} \\
{}=   (\apure\, (\comp) \alift{\comp}  \apure\, (\clift{\pappl}{\pstream{A}}) ) \appl m_g \appl \apure\, (\pappl) \appl m_f \appl m_a\\
 \mbox{composition law for }M \\
{}=   \apure\, ((\comp) \comp \clift{\pappl}{\pstream{A}}) \appl m_g \appl \apure\, (\pappl) \appl m_f \appl m_a\\
 \mbox{Lemma \ref{lemma:pure_lift}}\\
{}=    \apure\, (\clift{\clift{\pappl}{\pstream{A}}}{\pstream{A\rightarrow B}}) \appl m_g \appl \apure\, (\pappl) \appl m_f  \appl m_a\\
 \mbox{definition}\\
{}= \apure\, (\lambda \pstr{g} . \pstr{g} \clift{\clift{\pappl}{\pstream{A}}}{\pstream{A\rightarrow B}} (\pappl) ) \appl m_g  \appl m_f  \appl m_a\\
 \mbox{Lemma \ref{lemma:pure_lift}}\\
{}=  \apure\, (\lambda \pstr{g} . \lambda \pstr{f}. \lambda \pstr{a} . (\pstr{g}\, \pappl (\pstr{f} \pappl \pstr{a})) ) \appl m_g  \appl m_f  \appl m_a\\
 \mbox{Lemma \ref{lemma:comp_comp}}\\
\end{array}
$$
\end{proof}

% ---
\newpage

\begin{lemmaa}{\ref{lemma:ppair}}
$$
(\apure_M\,\ppair{\comp})\, \alift{\pappl}\, m_g\, \alift{\pappl}\, m_f\, \alift{\pappl}\, m_a
= \apure_M\,(\lambda \pstr{g}. \lambda \pstr{f}. \lambda \pstr{a}. \ppair{\comp}\, \pappl\, \pstr{g} \, \pappl\, \pstr{f} \, \pappl\, \pstr{a})\, \appl\, m_g\, \appl\, m_f\, \appl\, m_a 
$$
\end{lemmaa}
\begin{proof}
$$
\begin{array}{ll}
(\apure_M\,\ppair{\comp}) \alift{\pappl} m_g \alift{\pappl} m_f \alift{\pappl} m_a\\
{}=
(\apure_M\,(\pappl) \appl \apure_M\,\ppair{\comp} \appl m_g) \alift{\pappl} m_f \alift{\pappl} m_a\\
\mbox{definition of }\alift{-}\\
{}= (\apure_M\,(\ppair{\comp}\, \pappl) \appl m_g) \alift{\pappl} m_f \alift{\pappl} m_a\\
 \mbox{homomorphism law of }M\\
{}= (\apure_M\,(\pappl) \appl (\apure_M\,(\ppair{\comp}\, \pappl) \appl m_g) \appl m_f) \alift{\pappl} m_a\\
\mbox{definition of }\alift{-}\\
{}= (
       (\apure_M\,(\pappl) \alift{\comp} \apure_M\,(\ppair{\comp} \pappl {}))
       \appl m_g
     \appl m_f) \alift{\pappl} m_a\\
\mbox{composition law of }M\\
{}= ((
       \apure_M\,((\pappl) \comp (\ppair{\comp} \pappl {}))
       \appl m_g
     ) \appl m_f) \alift{\pappl} m_a\\
\mbox{Lemma \ref{lemma:pure_lift}}\\
{}= \apure_M\,(\pappl) \appl
    ((
       \apure_M\,((\pappl) \comp (\ppair{\comp} \pappl {}))
       \appl m_g
     ) \appl m_f) \appl m_a\\
\mbox{definition of }\alift{-}\\
{}= (\apure_M\,(\pappl) \alift{\comp}
     (\apure_M\,((\pappl) \comp (\ppair{\comp} \pappl {}))
       \appl m_g))
    \appl m_f \appl m_a\\
\mbox{composition law of }M\\
{}= \apure_M\,(\comp) \appl
     \apure_M\,(\pappl) \appl
     (\apure_M\,((\pappl) \comp (\ppair{\comp} \pappl {}))
       \appl m_g)
    \appl m_f \appl m_a\\
\mbox{definition of }\alift{-}\\
{}= \apure_M\,((\pappl) \comp {}) \appl
     (\apure_M\,((\pappl) \comp (\ppair{\comp} \pappl {}))
       \appl m_g)
    \appl m_f \appl m_a\\
 \mbox{homomorphism law of }M\\
{}= (\apure_M\,((\pappl) \comp {}) \alift{\comp}
     \apure_M\,((\pappl) \comp (\ppair{\comp} \pappl {})))
    \appl m_g \appl m_f \appl m_a\\
\mbox{composition law of }M\\
{}= \apure_M\,(((\pappl) \comp {}) \comp
                ((\pappl) \comp (\ppair{\comp} \pappl {})))
    \appl m_g \appl m_f \appl m_a\\
\mbox{Lemma \ref{lemma:pure_lift}}
\end{array}
$$

We are left with the daunting high-order expression:
$$
((\pappl) \comp {}) \comp ((\pappl) \comp (\ppair{\comp} \pappl {}))
$$
where the composition operator $\comp$ is used in several places with different types.
The whole expression has type $\pstream{B\rightarrow C}\rightarrow \pstream{A\rightarrow B} \rightarrow \pstream{A}\rightarrow \pstream{C}$.
If we apply it to elements $\pstr{g}$, $\pstr{f}$, $\pstr{a}$ and simplify by repeatedly applying the definition of composition, we get:
$$
\begin{array}{l}
(((\pappl) \comp {}) \comp ((\pappl) \comp (\ppair{\comp} \pappl {})))\,
\pstr{g}\,\pstr{f}\,\pstr{a}\\
{}= (((\pappl) \comp {}) (((\pappl) \comp (\ppair{\comp} \pappl {}))\,\pstr{g}))\,
    \pstr{f}\,\pstr{a}\\
{}= (((\pappl) \comp {}) ((\pappl) (\ppair{\comp} \pappl\pstr{g})))\,
    \pstr{f}\,\pstr{a}\\
{}= ((\pappl) ((\ppair{\comp} \pappl\pstr{g}) \pappl \pstr{f}))\,\pstr{a}\\
{}= (\ppair{\comp} \pappl\pstr{g}) \pappl \pstr{f})\pappl\pstr{a}\\
\end{array}
$$
Therefore:
$$
((\pappl) \comp {}) \comp ((\pappl) \comp (\ppair{\comp} \pappl {}))
= \lambda \pstr{g}. \lambda \pstr{f}. \lambda \pstr{a}.
  \ppair{\comp} \pappl\pstr{g} \pappl \pstr{f} \pappl\pstr{a}
$$
which concludes the proof.
\end{proof}
